# -*- coding: utf-8 -*-
"""ã€Œstk_ch06_otc.ipynbã€çš„å‰¯æœ¬

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1nOzVNbIbazXnokXoBYQACsnK8EcaWnGH

# CH-06 å€‹è‚¡åˆ†ææ©Ÿå™¨äºº

### 1ï¸âƒ£ å®‰è£åŠåŒ¯å…¥å¥—ä»¶
"""

# !pip install openai
# !pip install yfinance==0.2.38
from openai import OpenAI, OpenAIError # ä¸²æ¥ OpenAI API
import yfinance as yf
import pandas as pd # è³‡æ–™è™•ç†å¥—ä»¶
import numpy as np
import datetime as dt # æ™‚é–“å¥—ä»¶
import requests
from bs4 import BeautifulSoup

"""### 2ï¸âƒ£ è¼¸å…¥ OpenAI API KEY"""

import getpass # ä¿å¯†è¼¸å…¥å¥—ä»¶
api_key = getpass.getpass("è«‹è¼¸å…¥é‡‘é‘°ï¼š")
client = OpenAI(api_key = api_key) # å»ºç«‹ OpenAI ç‰©ä»¶

"""### 3ï¸âƒ£ å–å¾—è‚¡åƒ¹è³‡æ–™"""

# å¾ yfinance å–å¾—ä¸€å‘¨è‚¡åƒ¹è³‡æ–™
def stock_price(stock_id="å¤§ç›¤", days = 10):
  if stock_id == "å¤§ç›¤":
    stock_id="^TWII"
  else:
    stock_id

  end = dt.date.today() # è³‡æ–™çµæŸæ™‚é–“
  start = end - dt.timedelta(days=days) # è³‡æ–™é–‹å§‹æ™‚é–“
  # ä¸‹è¼‰è³‡æ–™
  df = yf.download(stock_id, start=start)

  # æ›´æ›åˆ—å
  df.columns = ['é–‹ç›¤åƒ¹', 'æœ€é«˜åƒ¹', 'æœ€ä½åƒ¹',
                'æ”¶ç›¤åƒ¹', 'èª¿æ•´å¾Œæ”¶ç›¤åƒ¹', 'æˆäº¤é‡']

  data = {
    'æ—¥æœŸ': df.index.strftime('%Y-%m-%d').tolist(),
    'æ”¶ç›¤åƒ¹': df['æ”¶ç›¤åƒ¹'].tolist(),
    'æ¯æ—¥å ±é…¬': df['æ”¶ç›¤åƒ¹'].pct_change().tolist(),
    'æ¼²è·Œåƒ¹å·®': df['èª¿æ•´å¾Œæ”¶ç›¤åƒ¹'].diff().tolist()
    }

  return data

print(stock_price("4205.TWO"))

"""### 4ï¸âƒ£ å–å¾—åŸºæœ¬é¢è³‡æ–™"""

# åŸºæœ¬é¢è³‡æ–™
def stock_fundamental(stock_id= "å¤§ç›¤"):
  if stock_id == "å¤§ç›¤":
      return None

  stock = yf.Ticker(stock_id)

  # ç‡Ÿæ”¶æˆé•·ç‡
  quarterly_revenue_growth = np.round(stock.quarterly_financials.loc["Total Revenue"].pct_change(-1).dropna().tolist(), 2)

  # æ¯å­£EPS
  quarterly_eps = np.round(stock.quarterly_financials.loc["Basic EPS"].dropna().tolist(), 2)

  # EPSå­£å¢ç‡
  quarterly_eps_growth = np.round(stock.quarterly_financials.loc["Basic EPS"].pct_change(-1).dropna().tolist(), 2)

  # è½‰æ›æ—¥æœŸ
  dates = [date.strftime('%Y-%m-%d') for date in stock.quarterly_financials.columns]

  data = {
      'å­£æ—¥æœŸ': dates[:len(quarterly_revenue_growth)],
      'ç‡Ÿæ”¶æˆé•·ç‡': quarterly_revenue_growth.tolist(),
      'EPS': quarterly_eps[0:3].tolist(),
      'EPS å­£å¢ç‡': quarterly_eps_growth[0:3].tolist()
  }

  return data

print(stock_fundamental("3526.TWO"))

"""### 5ï¸âƒ£ å–å¾—æ–°èè³‡æ–™"""

# æ–°èè³‡æ–™
def stock_news(stock_name ="å¤§ç›¤"):
  if stock_name == "å¤§ç›¤":
    stock_name="å°è‚¡ -ç›¤ä¸­é€Ÿå ±"

  data=[]
  # å–å¾— Json æ ¼å¼è³‡æ–™
  json_data = requests.get(f'https://ess.api.cnyes.com/ess/api/v1/news/keyword?q={stock_name}&limit=5&page=1').json()

  # ä¾ç…§æ ¼å¼æ“·å–è³‡æ–™
  items=json_data['data']['items']
  for item in items:
      # ç¶²å€ã€æ¨™é¡Œå’Œæ—¥æœŸ
      news_id = item["newsId"]
      title = item["title"]
      publish_at = item["publishAt"]
      # ä½¿ç”¨ UTC æ™‚é–“æ ¼å¼
      utc_time = dt.datetime.utcfromtimestamp(publish_at)
      formatted_date = utc_time.strftime('%Y-%m-%d')
      # å‰å¾€ç¶²å€æ“·å–å…§å®¹
      url = requests.get(f'https://news.cnyes.com/'
                        f'news/id/{news_id}').content
      soup = BeautifulSoup(url, 'html.parser')
      p_elements=soup .find_all('p')
      # æå–æ®µè½å†…å®¹
      p=''
      for paragraph in p_elements[4:]:
          p+=paragraph.get_text()
      data.append([stock_name, formatted_date ,title,p])
  return data

print(stock_news("å°ç©é›»"))

"""### 6ï¸âƒ£ çˆ¬å–è‚¡è™Ÿã€è‚¡åå°ç…§è¡¨"""

# å–å¾—å…¨éƒ¨è‚¡ç¥¨çš„è‚¡è™Ÿã€è‚¡å
def stock_name(type=2):
  print("ç·šä¸Šè®€å–è‚¡è™Ÿã€è‚¡åã€åŠå¸‚å ´åˆ¥")

  response = requests.get(f'https://isin.twse.com.tw/isin/C_public.jsp?strMode={type}')
  url_data = BeautifulSoup(response.text, 'html.parser')
  stock_company = url_data.find_all('tr')

  # è³‡æ–™è™•ç†
  data = [
      (row.find_all('td')[0].text.split('\u3000')[0].strip(),
        row.find_all('td')[0].text.split('\u3000')[1],
        row.find_all('td')[3].text.strip())
      for row in stock_company[2:] if len(row.find_all('td')[0].text.split('\u3000')[0].strip()) == 4
  ]

  df = pd.DataFrame(data, columns=['è‚¡è™Ÿ', 'è‚¡å', 'å¸‚å ´åˆ¥'])

  return df

name_df = stock_name()
name_df = pd.concat([name_df, stock_name(type=4)])

"""### 7ï¸âƒ£ å–å¾—è‚¡ç¥¨åç¨±"""

# å–å¾—è‚¡ç¥¨åç¨±
def get_stock_name(stock_id, name_df):
    stock_name = name_df.set_index('è‚¡è™Ÿ').loc[stock_id, 'è‚¡å']
    stock_type = name_df.set_index('è‚¡è™Ÿ').loc[stock_id, 'å¸‚å ´åˆ¥']
    return stock_name, stock_type


print(name_df.head())
print("--------------------------")
print(get_stock_name("3526",name_df))

"""### 8ï¸âƒ£ å»ºæ§‹ GPT 3.5 æ¨¡å‹"""

# å»ºç«‹ GPT 3.5-16k æ¨¡å‹
def get_reply(messages):
    try:
        response = client.chat.completions.create(
            model = "gpt-3.5-turbo",
            messages = messages
        )
        reply = response.choices[0].message.content
    except OpenAIError as err:
        reply = f"ç™¼ç”Ÿ {err.type} éŒ¯èª¤\n{err.message}"
    return reply

# å»ºç«‹è¨Šæ¯æŒ‡ä»¤(Prompt)
def generate_content_msg(stock_id, name_df):
    # ç²å–è‚¡ç¥¨åç¨±å’Œé¡å‹
    stock_name, stock_type = get_stock_name(stock_id, name_df) if stock_id != "å¤§ç›¤" else (stock_id, None)

    # æ ¹æ“šè‚¡ç¥¨é¡å‹èª¿æ•´è‚¡ç¥¨ID
    if stock_type == "ä¸Šå¸‚":
        stock_id += ".TW"
    elif stock_type == "ä¸Šæ«ƒ":
        stock_id += ".TWO"

    # ç²å–è‚¡ç¥¨åƒ¹æ ¼å’Œæ–°èè³‡æ–™
    price_data = stock_price(stock_id)
    news_data = stock_news(stock_name)

    # ç”Ÿæˆå…§å®¹è¨Šæ¯
    content_msg = f'è«‹ä¾æ“šä»¥ä¸‹è³‡æ–™ä¾†é€²è¡Œåˆ†æä¸¦çµ¦å‡ºä¸€ä»½å®Œæ•´çš„åˆ†æå ±å‘Š:\n'
    content_msg += f'è¿‘æœŸåƒ¹æ ¼è³‡è¨Š:\n {price_data}\n'

    if stock_id != "å¤§ç›¤":
        stock_value_data = stock_fundamental(stock_id)
        content_msg += f'æ¯å­£ç‡Ÿæ”¶è³‡è¨Šï¼š\n {stock_value_data}\n'

    content_msg += f'è¿‘æœŸæ–°èè³‡è¨Š: \n {news_data}\n'
    content_msg += f'è«‹çµ¦æˆ‘{stock_name}è¿‘æœŸçš„è¶¨å‹¢å ±å‘Š,è«‹ä»¥è©³ç´°ã€åš´è¬¹åŠå°ˆæ¥­çš„è§’åº¦æ’°å¯«æ­¤å ±å‘Š,ä¸¦æåŠé‡è¦çš„æ•¸å­—, reply in ç¹é«”ä¸­æ–‡'

    return content_msg


# StockGPT
def stock_gpt(stock_id, name_df=name_df):
    content_msg = generate_content_msg(stock_id, name_df)

    msg = [{
        "role": "system",
        "content": f"ä½ ç¾åœ¨æ˜¯ä¸€ä½å°ˆæ¥­çš„è­‰åˆ¸åˆ†æå¸«, ä½ æœƒçµ±æ•´è¿‘æœŸçš„è‚¡åƒ¹\
      ã€åŸºæœ¬é¢ã€æ–°èè³‡è¨Šç­‰æ–¹é¢ä¸¦é€²è¡Œåˆ†æ, ç„¶å¾Œç”Ÿæˆä¸€ä»½å°ˆæ¥­çš„è¶¨å‹¢åˆ†æå ±å‘Š"
    }, {
        "role": "user",
        "content": content_msg
    }]

    reply_data = get_reply(msg)

    return reply_data

"""### 9ï¸âƒ£ å¤§ç›¤è¶¨å‹¢å ±å‘Š"""

reply = stock_gpt(stock_id="å¤§ç›¤")
print(reply)

"""### ğŸ”Ÿ ä¸Šå¸‚ä¸Šæ«ƒéƒ½ OK"""

reply = stock_gpt(stock_id="3526")
print(reply)